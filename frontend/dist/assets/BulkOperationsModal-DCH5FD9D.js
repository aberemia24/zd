import{r as c,j as e,I as O,T as S,C as z,S as A,a as q,b as P,B as h}from"./index-CA872eiw.js";import{t as B,a as I,b as F,c as Y,d as K,e as H,f as W}from"./modal-CRaOp9Kc.js";import{u as Z}from"./useBaseModalLogic-CiDSqnDQ.js";const U=({cellContext:D,operation:s,selectedCells:i,onSave:j,onCancel:b})=>{const{form:t,validation:o,loading:l,calculations:v}=Z(D),[d,u]=c.useState("configure"),[L,T]=c.useState({applyToAll:!0,preserveExisting:!1,skipErrors:!0}),[n,N]=c.useState({total:0,completed:0,failed:0,isRunning:!1}),[y,R]=c.useState([]),[x,m]=c.useState(!1);c.useEffect(()=>{s==="delete"?u("configure"):t.updateData({amount:"0.00",description:"",recurring:!1})},[s,t]);const f={create:"Crează Tranzacții Multiple",edit:"Editează Tranzacții în Lot",delete:"Șterge Tranzacții Selectate",copy:"Copiază Tranzacții"},$=[{key:"applyToAll",label:"Aplică aceleași valori la toate selecțiile",description:"Toate celulele vor avea aceleași date"},{key:"preserveExisting",label:"Păstrează valorile existente dacă există",description:"Nu suprascrie tranzacțiile existente"},{key:"skipErrors",label:"Ignoră erorile și continuă",description:"Continuă operația chiar dacă unele celule eșuează"}],k=c.useCallback(()=>{const a=i.map((r,g)=>{const C=t.data.amount?Number(t.data.amount):r.currentAmount||0,M=t.data.description||`Tranzacție ${g+1}`;return{id:`preview-${g}`,cell:r,data:{amount:C,description:M,recurring:t.data.recurring,frequency:t.data.frequency},status:s==="delete"?"pending-delete":"pending-create",estimatedResult:s==="delete"?"deleted":"created"}});R(a)},[i,t.data,s]);c.useEffect(()=>{d==="preview"&&k()},[d,k]);const p=c.useCallback(async()=>{if(s==="delete"&&!x){m(!0);return}if(!(s!=="delete"&&!t.validate())){N({total:i.length,completed:0,failed:0,isRunning:!0}),u("progress"),l.setIsLoading(!0);try{const a={operation:s,selections:i,commonData:s!=="delete"?{amount:t.data.amount,description:t.data.description,recurring:t.data.recurring,frequency:t.data.frequency}:void 0,deleteConfirmation:s==="delete"};await j(a)}catch{o.setErrors({general:`Eroare la executarea operației ${s}. Încercați din nou.`}),u("configure"),N(r=>({...r,isRunning:!1}))}finally{l.setIsLoading(!1),m(!1)}}},[s,t,o,l,i,j,x]);c.useEffect(()=>{const a=r=>{r.key==="Enter"&&r.ctrlKey&&(r.preventDefault(),p()),r.key==="Escape"&&(r.preventDefault(),x?m(!1):b()),r.key==="p"&&r.ctrlKey&&(r.preventDefault(),d!=="progress"&&u(d==="configure"?"preview":"configure"))};return document.addEventListener("keydown",a),()=>document.removeEventListener("keydown",a)},[p,b,d,x]);const w=t.data.amount&&s!=="delete"?v.formatMoney(Number(t.data.amount)*i.length):null,E=a=>`${a.category}${a.subcategory?` → ${a.subcategory}`:""} (${a.day}/${a.month}/${a.year})`;return e.jsx("div",{className:B({blur:!0}),children:e.jsxs("div",{className:I({mode:"bulk-operations"}),children:[e.jsxs("div",{className:F({variant:"primary"}),children:[e.jsxs("div",{children:[e.jsx("h2",{className:Y({variant:"primary"}),children:f[s]}),e.jsxs("div",{className:"text-sm text-blue-700 mt-1",children:[i.length," celule selectate"]})]}),e.jsx("button",{className:K(),onClick:b,"data-testid":"bulk-operations-modal-close",children:"✕"})]}),e.jsx("div",{className:"px-6 py-2 border-b border-blue-200 bg-blue-50",children:e.jsxs("div",{className:"flex space-x-4",children:[e.jsx("button",{className:`px-3 py-1 text-sm font-medium transition-colors ${d==="configure"?"text-blue-900 border-b-2 border-blue-600":"text-blue-600 hover:text-blue-800"}`,onClick:()=>u("configure"),"data-testid":"configure-tab",disabled:n.isRunning,children:"Configurează"}),s!=="delete"&&e.jsxs("button",{className:`px-3 py-1 text-sm font-medium transition-colors ${d==="preview"?"text-blue-900 border-b-2 border-blue-600":"text-blue-600 hover:text-blue-800"}`,onClick:()=>u("preview"),"data-testid":"preview-tab",disabled:n.isRunning,children:["Preview (",i.length,")"]}),n.isRunning&&e.jsx("button",{className:"px-3 py-1 text-sm font-medium text-blue-900 border-b-2 border-blue-600","data-testid":"progress-tab",children:"Progres"})]})}),e.jsxs("div",{className:H(),children:[d==="configure"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-sm text-slate-600 bg-blue-50 p-3 rounded-md",children:[e.jsx("strong",{children:"Operație:"})," ",f[s],e.jsx("br",{}),e.jsx("strong",{children:"Celule selectate:"})," ",i.length,e.jsx("br",{}),e.jsxs("div",{className:"mt-2 max-h-24 overflow-y-auto",children:[i.slice(0,3).map((a,r)=>e.jsxs("div",{className:"text-xs",children:["• ",E(a)]},r)),i.length>3&&e.jsxs("div",{className:"text-xs text-blue-600",children:["+ încă ",i.length-3," celule..."]})]})]}),s!=="delete"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{children:e.jsx(O,{label:"Sumă (RON)",type:"number",step:"0.01",value:t.data.amount,onChange:a=>t.updateData({amount:a.target.value}),error:o.errors.amount,"data-testid":"bulk-amount-input",placeholder:"0.00"})}),e.jsx("div",{children:e.jsx(S,{label:"Descriere (opțional)",value:t.data.description,onChange:a=>t.updateData({description:a.target.value}),error:o.errors.description,"data-testid":"bulk-description-input",placeholder:"Descriere pentru toate tranzacțiile...",rows:2})}),e.jsx("div",{children:e.jsx(z,{label:"Tranzacții recurente",checked:t.data.recurring,onChange:a=>{const r=a.target.checked;t.updateData({recurring:r}),r||t.updateData({frequency:void 0})},"data-testid":"bulk-recurring-checkbox"})}),t.data.recurring&&e.jsx("div",{className:"pl-6 border-l-2 border-blue-200",children:e.jsx(A,{label:"Frecvență",value:t.data.frequency||"",onChange:a=>t.updateData({frequency:a.target.value}),options:[{value:"DAILY",label:"Zilnic"},{value:"WEEKLY",label:"Săptămânal"},{value:"MONTHLY",label:"Lunar"},{value:"YEARLY",label:"Anual"}],error:o.errors.frequency,"data-testid":"bulk-frequency-select",placeholder:"Selectează frecvența"})}),w&&e.jsxs("div",{className:"bg-slate-50 p-4 rounded-md text-sm space-y-2",children:[e.jsx("h4",{className:"font-semibold text-slate-800",children:"Impact Financiar Total"}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Sumă per tranzacție:"}),e.jsxs("span",{className:"font-medium",children:[v.formatMoney(Number(t.data.amount))," RON"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Număr de tranzacții:"}),e.jsx("span",{className:"font-medium",children:i.length})]}),e.jsxs("div",{className:"flex justify-between border-t pt-2",children:[e.jsx("span",{className:"font-semibold",children:"Total impact:"}),e.jsxs("span",{className:"font-semibold text-blue-600",children:[w," RON"]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-3",children:"Opțiuni pentru Operațiile în Lot"}),e.jsx("div",{className:"space-y-3",children:$.map(a=>e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(z,{checked:L[a.key],onChange:r=>T(g=>({...g,[a.key]:r.target.checked})),"data-testid":`bulk-option-${a.key}`}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium text-slate-700",children:a.label}),e.jsx("div",{className:"text-xs text-slate-500",children:a.description})]})]},a.key))})]}),o.errors.general&&e.jsx("div",{className:"text-red-600 text-sm bg-red-50 p-3 rounded-md",children:o.errors.general})]}),d==="preview"&&s!=="delete"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h4",{className:"font-semibold text-slate-800",children:["Preview Operație: ",i.length," tranzacții"]}),y.length===0?e.jsx("div",{className:"text-center py-8 text-slate-500",children:"Nu există date pentru preview. Configurați operația în primul tab."}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:y.map((a,r)=>e.jsx("div",{className:"bg-slate-50 p-3 rounded-md border-l-4 border-blue-200",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-slate-800",children:E(a.cell)}),e.jsxs("div",{className:"text-sm text-slate-600 mt-1",children:["Sumă: ",v.formatMoney(a.data.amount)," RON",a.data.description&&` • ${a.data.description}`,a.data.recurring&&` • Recurent (${a.data.frequency})`]})]}),e.jsx(q,{variant:"primary",className:"text-xs",children:a.estimatedResult==="created"?"Creat":"Actualizat"})]})},a.id))})]}),d==="progress"&&n.isRunning&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx(P,{size:"lg",className:"mx-auto mb-4"}),e.jsx("h4",{className:"font-semibold text-slate-800 mb-2",children:"Executare Operație în Progres..."}),e.jsx("p",{className:"text-slate-600",children:n.current||"Procesare tranzacții..."})]}),e.jsx("div",{className:"w-full bg-slate-200 rounded-full h-3",children:e.jsx("div",{className:"bg-blue-600 h-3 rounded-full transition-all duration-300",style:{width:`${n.completed/n.total*100}%`}})}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-center",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-slate-800",children:n.total}),e.jsx("div",{className:"text-sm text-slate-600",children:"Total"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-emerald-600",children:n.completed}),e.jsx("div",{className:"text-sm text-slate-600",children:"Completate"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:n.failed}),e.jsx("div",{className:"text-sm text-slate-600",children:"Eșuate"})]})]})]})]}),x&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-lg max-w-md",children:[e.jsx("h3",{className:"text-lg font-semibold text-red-800 mb-4",children:"Confirmă Ștergerea în Lot"}),e.jsxs("p",{className:"text-slate-600 mb-6",children:["Ești sigur că vrei să ștergi ",e.jsxs("strong",{children:[i.length," tranzacții"]}),"? Această acțiune nu poate fi anulată."]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(h,{variant:"secondary",onClick:()=>m(!1),disabled:l.isLoading,children:"Anulează"}),e.jsx(h,{variant:"danger",onClick:p,disabled:l.isLoading,children:l.isLoading?"Șterge...":"Șterge Toate"})]})]})}),e.jsx("div",{className:W(),children:e.jsxs("div",{className:"flex justify-between w-full",children:[e.jsx("div",{children:s==="delete"&&!n.isRunning&&e.jsxs(h,{variant:"danger",onClick:()=>m(!0),disabled:l.isLoading,"data-testid":"bulk-delete-button",children:["Șterge Toate (",i.length,")"]})}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(h,{variant:"secondary",onClick:b,disabled:l.isLoading||n.isRunning,"data-testid":"bulk-operations-cancel-button",children:"Anulează"}),s!=="delete"&&!n.isRunning&&e.jsx(h,{variant:"primary",onClick:p,disabled:l.isLoading||!t.data.amount,"data-testid":"bulk-operations-execute-button",children:l.isLoading?"Execută...":`Execută ${f[s]} (Ctrl+Enter)`})]})]})})]})})};export{U as BulkOperationsModal};
