import{r as i,j as e,I as p,T as U,S as K,B as D,a as V}from"./index-CA872eiw.js";import{t as X,a as _,b as ee,c as ae,d as te,e as re,f as se}from"./modal-CRaOp9Kc.js";const de=({cellContext:r,existingTemplate:s,prefillAmount:g="",onSave:S,onCancel:h})=>{var C,I,A,P,$,T;const[l,w]=i.useState({}),[m,j]=i.useState(""),[d,E]=i.useState(1),[n,k]=i.useState("never"),[u,z]=i.useState(""),[c,L]=i.useState(12),[v,M]=i.useState("skip"),[f,q]=i.useState(!1),[x,B]=i.useState([]);i.useEffect(()=>{s?(form.updateData({amount:s.amount.toString(),description:s.description,recurring:!0,frequency:s.frequency}),j(s.name),E(s.interval),k(s.endType),z(s.endDate||""),L(s.endCount||12),M(s.conflictStrategy)):(g&&form.updateData({amount:g}),form.updateData({recurring:!0,frequency:"MONTHLY"}),j(`${r.category} - Recurent`))},[s,g,form,r.category]);const H=[{value:"DAILY",label:"Zilnic"},{value:"WEEKLY",label:"Săptămânal"},{value:"MONTHLY",label:"Lunar"},{value:"YEARLY",label:"Anual"}],W=[{value:"never",label:"Nu se termină niciodată"},{value:"date",label:"Până la o dată specifică"},{value:"count",label:"Număr fix de tranzacții"}],G=[{value:"skip",label:"Omite tranzacția"},{value:"adjust",label:"Ajustează data"},{value:"create",label:"Creează oricum"}],Y=i.useCallback(()=>{if(!form.data.amount||!form.data.frequency)return[];const a=[],t=new Date(r.year,r.month-1,r.day),y=Number(form.data.amount);let o=new Date(t),b=0;const J=n==="count"?Math.min(c,12):12;for(;b<J;){if(n==="date"&&u){const Q=new Date(u);if(o>Q)break}if(n==="count"&&b>=c)break;const F={date:o.toISOString().split("T")[0],amount:y,description:form.data.description||`${m} - ${b+1}`,status:"scheduled"};switch(Math.random()>.8&&(F.status=v==="skip"?"conflict":v==="adjust"?"adjusted":"scheduled"),a.push(F),form.data.frequency){case"DAILY":o.setDate(o.getDate()+d);break;case"WEEKLY":o.setDate(o.getDate()+7*d);break;case"MONTHLY":o.setMonth(o.getMonth()+d);break;case"YEARLY":o.setFullYear(o.getFullYear()+d);break}b++}return a},[form.data.amount,form.data.frequency,form.data.description,m,r,d,n,u,c,v]);i.useEffect(()=>{if(f){const a=Y();B(a)}},[f,Y]);const O=i.useCallback(()=>{const a={};if(m.trim()||(a.templateName="Numele template-ului este obligatoriu"),(d<1||d>365)&&(a.interval="Intervalul trebuie să fie între 1 și 365"),n==="date"&&u){const t=new Date(u),y=new Date(r.year,r.month-1,r.day);t<=y&&(a.endDate="Data de sfârșit trebuie să fie după data de început")}return n==="count"&&(c<1||c>1e3)&&(a.endCount="Numărul de tranzacții trebuie să fie între 1 și 1000"),w({...l,...a}),Object.keys(a).length===0},[m,d,n,u,c,r,l]),N=i.useCallback(async()=>{if(!(!form.validate()||!O())){loading.setIsLoading(!0);try{const a={id:s==null?void 0:s.id,name:m,amount:Number(form.data.amount),description:form.data.description,frequency:form.data.frequency,interval:d,endType:n,endDate:n==="date"?u:void 0,endCount:n==="count"?c:void 0,conflictStrategy:v,isActive:!0,category:r.category,subcategory:r.subcategory,type:"expense"};await S(a)}catch{w({...l,general:"Eroare la salvarea template-ului recurent. Încercați din nou."})}finally{loading.setIsLoading(!1)}}},[form,O,loading,S,m,d,n,u,c,v,r,s,l]);i.useEffect(()=>{const a=t=>{t.key==="Enter"&&t.ctrlKey&&(t.preventDefault(),N()),t.key==="Escape"&&(t.preventDefault(),h()),t.key==="p"&&t.ctrlKey&&(t.preventDefault(),q(!f))};return document.addEventListener("keydown",a),()=>document.removeEventListener("keydown",a)},[N,h,f]);const R=form.data.amount&&n==="count"?calculations.formatMoney(Number(form.data.amount)*c):null,Z=(a,t)=>({DAILY:t===1?"zilnic":`la ${t} zile`,WEEKLY:t===1?"săptămânal":`la ${t} săptămâni`,MONTHLY:t===1?"lunar":`la ${t} luni`,YEARLY:t===1?"anual":`la ${t} ani`})[a]||a;return e.jsx("div",{className:X({blur:!0}),children:e.jsxs("div",{className:_({mode:"recurring-setup"}),children:[e.jsxs("div",{className:ee({variant:"primary"}),children:[e.jsx("h2",{className:ae({variant:"primary"}),children:s?"Editează Template Recurent":"Configurează Tranzacție Recurentă"}),e.jsx("button",{className:te(),onClick:h,"data-testid":"recurring-setup-modal-close",children:"✕"})]}),e.jsxs("div",{className:re(),children:[e.jsxs("div",{className:"text-sm text-slate-600 bg-blue-50 p-3 rounded-md",children:[e.jsx("strong",{children:r.category}),r.subcategory&&` → ${r.subcategory}`,e.jsx("br",{}),e.jsxs("span",{children:["Start: ",r.day,"/",r.month,"/",r.year]})]}),e.jsx("div",{children:e.jsx(p,{label:"Nume Template",value:m,onChange:a=>j(a.target.value),error:l.templateName,"data-testid":"template-name-input",placeholder:"ex: Salariu lunar, Chirie, etc."})}),e.jsx("div",{children:e.jsx(p,{label:"Sumă (RON)",type:"number",step:"0.01",value:form.data.amount,onChange:a=>form.updateData({amount:a.target.value}),error:(I=(C=form.validation)==null?void 0:C.errors)==null?void 0:I.amount,"data-testid":"recurring-amount-input",placeholder:"0.00"})}),e.jsx("div",{children:e.jsx(U,{label:"Descriere (opțional)",value:form.data.description,onChange:a=>form.updateData({description:a.target.value}),error:(P=(A=form.validation)==null?void 0:A.errors)==null?void 0:P.description,"data-testid":"recurring-description-input",placeholder:"Descriere pentru toate tranzacțiile generate...",rows:2})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsx(K,{label:"Frecvență",value:form.data.frequency||"",onChange:a=>form.updateData({frequency:a.target.value}),options:H,error:(T=($=form.validation)==null?void 0:$.errors)==null?void 0:T.frequency,"data-testid":"recurring-frequency-select",placeholder:"Selectează frecvența"})}),e.jsx("div",{children:e.jsx(p,{label:"Interval",type:"number",min:"1",max:"365",value:d.toString(),onChange:a=>E(Number(a.target.value)),error:l.interval,"data-testid":"recurring-interval-input",placeholder:"1"})})]}),form.data.frequency&&e.jsxs("div",{className:"text-sm text-blue-700 bg-blue-50 p-2 rounded",children:["Se repetă: ",e.jsx("strong",{children:Z(form.data.frequency,d)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:"Când se termină?"}),e.jsx("div",{className:"space-y-3",children:W.map(a=>e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",name:"endType",value:a.value,checked:n===a.value,onChange:t=>k(t.target.value),className:"mr-2","data-testid":`end-type-${a.value}`}),e.jsx("span",{className:"text-sm text-slate-700",children:a.label})]},a.value))})]}),n==="date"&&e.jsx("div",{children:e.jsx(p,{label:"Data de sfârșit",type:"date",value:u,onChange:a=>z(a.target.value),error:l.endDate,"data-testid":"recurring-end-date-input"})}),n==="count"&&e.jsx("div",{children:e.jsx(p,{label:"Număr de tranzacții",type:"number",min:"1",max:"1000",value:c.toString(),onChange:a=>L(Number(a.target.value)),error:l.endCount,"data-testid":"recurring-end-count-input",placeholder:"12"})}),e.jsxs("div",{children:[e.jsx(K,{label:"Strategie pentru conflicte",value:v,onChange:a=>M(a.target.value),options:G,"data-testid":"conflict-strategy-select"}),e.jsx("div",{className:"text-xs text-slate-500 mt-1",children:"Ce se întâmplă când data calculată coincide cu o tranzacție existentă"})]}),R&&e.jsxs("div",{className:"bg-slate-50 p-4 rounded-md text-sm space-y-2",children:[e.jsx("h4",{className:"font-semibold text-slate-800",children:"Rezumat Financiar"}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Sumă per tranzacție:"}),e.jsxs("span",{className:"font-medium",children:[calculations.formatMoney(Number(form.data.amount))," RON"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Număr de tranzacții:"}),e.jsx("span",{className:"font-medium",children:c})]}),e.jsxs("div",{className:"flex justify-between border-t pt-2",children:[e.jsx("span",{className:"font-semibold",children:"Total impact:"}),e.jsxs("span",{className:"font-semibold text-blue-600",children:[R," RON"]})]})]}),e.jsx("div",{children:e.jsx(D,{variant:"secondary",onClick:()=>q(!f),"data-testid":"toggle-preview-button",disabled:!form.data.amount||!form.data.frequency,children:f?"Ascunde Preview":"Afișează Preview (Ctrl+P)"})}),f&&e.jsxs("div",{className:"bg-slate-50 p-4 rounded-md",children:[e.jsxs("h4",{className:"font-semibold text-slate-800 mb-3",children:["Preview Tranzacții Generate (primele ",Math.min(x.length,12),")"]}),x.length===0?e.jsx("div",{className:"text-center py-4 text-slate-500",children:"Nu se pot genera tranzacții cu parametrii actuali."}):e.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto",children:x.map((a,t)=>e.jsxs("div",{className:"flex justify-between items-center bg-white p-2 rounded text-sm",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium",children:new Date(a.date).toLocaleDateString("ro-RO")}),e.jsx("div",{className:"text-slate-600 text-xs truncate",children:a.description})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("span",{className:"font-medium",children:[calculations.formatMoney(a.amount)," RON"]}),e.jsx(V,{variant:a.status==="scheduled"?"secondary":a.status==="conflict"?"warning":"primary",className:"text-xs",children:a.status==="scheduled"?"OK":a.status==="conflict"?"Conflict":"Ajustat"})]})]},t))})]}),l.general&&e.jsx("div",{className:"text-red-600 text-sm bg-red-50 p-3 rounded-md",children:l.general})]}),e.jsxs("div",{className:se(),children:[e.jsx(D,{variant:"secondary",onClick:h,disabled:loading.isLoading,"data-testid":"recurring-setup-cancel-button",children:"Anulează"}),e.jsx(D,{variant:"primary",onClick:N,disabled:loading.isLoading||!form.data.amount||!m.trim(),"data-testid":"recurring-setup-save-button",children:loading.isLoading?"Salvează...":"Creează Template (Ctrl+Enter)"})]})]})})};export{de as RecurringSetupModal};
