import{r as l,j as e,a as L,I as z,T as S,C,S as M,B as u}from"./index-CA872eiw.js";import{t as O,a as T,b as q,c as V,d as A,e as R,f as F}from"./modal-CRaOp9Kc.js";import{u as B}from"./useBaseModalLogic-CiDSqnDQ.js";const K=({cellContext:d,transaction:s,showHistory:k=!0,onSave:j,onDelete:c,onCancel:m})=>{const{form:t,validation:n,loading:r,calculations:x}=B(d),[h,y]=l.useState("edit"),[b,D]=l.useState([]),[f,o]=l.useState(!1);l.useEffect(()=>{s&&!t.data.amount&&t.updateData({amount:s.amount.toString(),description:s.description,recurring:s.recurring,frequency:s.frequency})},[s]),l.useEffect(()=>{const a=[{id:"1",field:"amount",oldValue:100,newValue:s.amount,timestamp:new Date(Date.now()-864e5).toISOString(),userId:"user-1"},{id:"2",field:"description",oldValue:"Old description",newValue:s.description,timestamp:new Date(Date.now()-1728e5).toISOString(),userId:"user-1"}];D(a)},[s]);const v=l.useCallback(async()=>{if(t.validate()){r.setIsLoading(!0);try{await j({id:s.id,amount:t.data.amount,description:t.data.description,type:s.type,recurring:t.data.recurring,frequency:t.data.frequency,category:d.category,subcategory:d.subcategory})}catch{n.setErrors({general:"Eroare la actualizarea tranzacției. Încercați din nou."})}finally{r.setIsLoading(!1)}}},[t,r,n,j,s.id,s.type,d]),E=l.useCallback(async()=>{if(c){r.setIsLoading(!0);try{await c(s.id)}catch{n.setErrors({general:"Eroare la ștergerea tranzacției. Încercați din nou."}),o(!1)}finally{r.setIsLoading(!1)}}},[c,s.id,r,n]);l.useEffect(()=>{const a=i=>{i.key==="Enter"&&i.ctrlKey&&(i.preventDefault(),v()),i.key==="Escape"&&(i.preventDefault(),f?o(!1):m()),i.key==="Delete"&&i.ctrlKey&&c&&(i.preventDefault(),o(!0))};return document.addEventListener("keydown",a),()=>document.removeEventListener("keydown",a)},[v,m,f,c]);const g=x.calculateFinancialImpact(s.amount),p=t.data.amount?x.calculateFinancialImpact(Number(t.data.amount)):null,N=a=>typeof a=="number"?x.formatMoney(a)+" RON":String(a),w=a=>new Intl.DateTimeFormat("ro-RO",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}).format(new Date(a)),I=[{value:"DAILY",label:"Zilnic"},{value:"WEEKLY",label:"Săptămânal"},{value:"MONTHLY",label:"Lunar"},{value:"YEARLY",label:"Anual"}];return e.jsx("div",{className:O({blur:!0}),children:e.jsxs("div",{className:T({mode:"advanced-edit"}),children:[e.jsxs("div",{className:q({variant:"primary"}),children:[e.jsxs("div",{children:[e.jsx("h2",{className:V({variant:"primary"}),children:"Editează Tranzacția"}),e.jsxs("div",{className:"text-sm text-blue-700 mt-1",children:["ID: ",s.id," • Creată: ",w(s.createdAt)]})]}),e.jsx("button",{className:A(),onClick:m,"data-testid":"advanced-edit-modal-close",children:"✕"})]}),e.jsx("div",{className:"px-6 py-2 border-b border-blue-200 bg-blue-50",children:e.jsxs("div",{className:"flex space-x-4",children:[e.jsx("button",{className:`px-3 py-1 text-sm font-medium transition-colors ${h==="edit"?"text-blue-900 border-b-2 border-blue-600":"text-blue-600 hover:text-blue-800"}`,onClick:()=>y("edit"),"data-testid":"edit-tab",children:"Editează"}),k&&e.jsxs("button",{className:`px-3 py-1 text-sm font-medium transition-colors ${h==="history"?"text-blue-900 border-b-2 border-blue-600":"text-blue-600 hover:text-blue-800"}`,onClick:()=>y("history"),"data-testid":"history-tab",children:["Istoric (",b.length,")"]})]})}),e.jsxs("div",{className:R(),children:[h==="edit"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-sm text-slate-600 bg-blue-50 p-3 rounded-md",children:[e.jsx("strong",{children:d.category}),d.subcategory&&` → ${d.subcategory}`,e.jsx("br",{}),e.jsxs("span",{children:[d.day,"/",d.month,"/",d.year]}),e.jsx(L,{variant:s.type==="income"?"success":"error",className:"ml-2",children:s.type==="income"?"Venit":"Cheltuială"})]}),e.jsx("div",{children:e.jsx(z,{label:"Sumă (RON)",type:"text",pattern:"[0-9]+([,.][0-9]{1,2})?",value:t.data.amount,onChange:a=>t.updateData({amount:a.target.value}),error:n.errors.amount,"data-testid":"advanced-edit-amount-input",placeholder:"0.00"})}),e.jsx("div",{children:e.jsx(S,{label:"Descriere",value:t.data.description,onChange:a=>t.updateData({description:a.target.value}),error:n.errors.description,"data-testid":"advanced-edit-description-input",placeholder:"Detalii despre tranzacție...",rows:3})}),e.jsx("div",{children:e.jsx(C,{label:"Tranzacție recurentă",checked:t.data.recurring,onChange:a=>{const i=a.target.checked;t.updateData({recurring:i}),i||t.updateData({frequency:void 0})},"data-testid":"advanced-edit-recurring-checkbox"})}),t.data.recurring&&e.jsx("div",{className:"pl-6 border-l-2 border-blue-200",children:e.jsx(M,{label:"Frecvență",value:t.data.frequency||"",onChange:a=>t.updateData({frequency:a.target.value}),options:I,error:n.errors.frequency,"data-testid":"advanced-edit-frequency-select",placeholder:"Selectează frecvența"})}),p&&e.jsxs("div",{className:"bg-slate-50 p-4 rounded-md text-sm space-y-3",children:[e.jsx("h4",{className:"font-semibold text-slate-800",children:"Comparație Impact Financiar"}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-slate-600",children:"Valoare originală:"}),e.jsxs("span",{className:`font-semibold ${g.isPositive?"text-emerald-600":"text-red-600"}`,children:[g.isPositive?"+":"",g.amount," RON"]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-slate-600",children:"Valoare nouă:"}),e.jsxs("span",{className:`font-semibold ${p.isPositive?"text-emerald-600":"text-red-600"}`,children:[p.isPositive?"+":"",p.amount," RON"]})]}),Number(t.data.amount)!==s.amount&&e.jsxs("div",{className:"flex justify-between items-center pt-2 border-t border-slate-200",children:[e.jsx("span",{className:"text-slate-800 font-medium",children:"Diferență:"}),e.jsxs("span",{className:`font-semibold ${Number(t.data.amount)>s.amount?"text-emerald-600":"text-red-600"}`,children:[Number(t.data.amount)>s.amount?"+":"",x.formatMoney(Number(t.data.amount)-s.amount)," RON"]})]})]}),n.errors.general&&e.jsx("div",{className:"text-red-600 text-sm bg-red-50 p-3 rounded-md",children:n.errors.general})]}),h==="history"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-semibold text-slate-800",children:"Istoric Modificări"}),b.length===0?e.jsx("div",{className:"text-center py-8 text-slate-500",children:"Nu există modificări înregistrate pentru această tranzacție."}):e.jsx("div",{className:"space-y-3",children:b.map(a=>e.jsx("div",{className:"bg-slate-50 p-3 rounded-md border-l-4 border-blue-200",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium text-slate-800 capitalize",children:[a.field," actualizat"]}),e.jsxs("div",{className:"text-sm text-slate-600 mt-1",children:[e.jsx("span",{className:"line-through text-red-600",children:N(a.oldValue)})," → ",e.jsx("span",{className:"text-emerald-600",children:N(a.newValue)})]})]}),e.jsx("div",{className:"text-xs text-slate-500 ml-4",children:w(a.timestamp)})]})},a.id))})]})]}),f&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-10",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-lg max-w-md",children:[e.jsx("h3",{className:"text-lg font-semibold text-red-800 mb-4",children:"Confirmă Ștergerea"}),e.jsx("p",{className:"text-slate-600 mb-6",children:"Ești sigur că vrei să ștergi această tranzacție? Această acțiune nu poate fi anulată."}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(u,{variant:"secondary",onClick:()=>o(!1),disabled:r.isLoading,children:"Anulează"}),e.jsx(u,{variant:"danger",onClick:E,disabled:r.isLoading,children:r.isLoading?"Șterge...":"Șterge Definitiv"})]})]})}),e.jsx("div",{className:F(),children:e.jsxs("div",{className:"flex justify-between w-full",children:[e.jsx("div",{children:c&&e.jsx(u,{variant:"danger",onClick:()=>o(!0),disabled:r.isLoading,"data-testid":"advanced-edit-delete-button",children:"Șterge (Ctrl+Del)"})}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx(u,{variant:"secondary",onClick:m,disabled:r.isLoading,"data-testid":"advanced-edit-cancel-button",children:"Anulează"}),e.jsx(u,{variant:"primary",onClick:v,disabled:r.isLoading||!t.data.amount,"data-testid":"advanced-edit-save-button",children:r.isLoading?"Salvează...":"Salvează Modificările (Ctrl+Enter)"})]})]})})]})})};export{K as AdvancedEditModal};
